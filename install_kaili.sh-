#!/bin/bash

# Ø³ÙƒØ±ÙŠØ¨Øª ØªØ«Ø¨ÙŠØª ÙƒØ§Ù„ÙŠ Ù„ÙŠÙ†ÙƒØ³ ÙƒØ§Ù…Ù„ Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
# ØªÙ†ÙÙŠØ°: nano install_kali.sh && chmod +x install_kali.sh && ./install_kali.sh

# ------ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† ------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# ------ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ------
LOG_FILE="kali-install-$(date +%Y%m%d%H%M%S).log"
exec > >(tee -i "$LOG_FILE")
exec 2>&1

# ------ Ø¯Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ------
clean_previous_attempts() {
    echo -e "${YELLOW}[ØªÙ†Ø¸ÙŠÙ]${NC} Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙ†Ø¸ÙŠÙ..."
    
    targets=(
        "kali-fs" "kali-rootfs.tar.xz" "start-kali" 
        "kali.sh" ".kali-installed" "nh-kali"
    )
    
    for target in "${targets[@]}"; do
        if [[ -e "$target" ]]; then
            echo -e "${BLUE}â€¢${NC} Ø¥Ø²Ø§Ù„Ø©: $target"
            rm -rf "$target"
        fi
    done
    
    pkg clean >/dev/null 2>&1
}

check_dependencies() {
    echo -e "${YELLOW}[Ø§Ù„ØªØ­Ù‚Ù‚]${NC} Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª..."
    
    dependencies=("proot" "wget" "curl" "tar" "xz-utils")
    
    for pkg in "${dependencies[@]}"; do
        if ! command -v "$pkg" >/dev/null 2>&1; then
            echo -e "${BLUE}â€¢${NC} ØªØ«Ø¨ÙŠØª: $pkg"
            pkg install -y "$pkg" || exit 1
        fi
    done
}

install_kali() {
    echo -e "${YELLOW}[ØªØ«Ø¨ÙŠØª]${NC} Ø¨Ø¯Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¬Ø¯ÙŠØ¯..."
    
    # ØªÙ†Ø²ÙŠÙ„ rootfs
    KALI_URL="https://kali.download/nethunter-images/current/rootfs/kalifs-arm64-minimal.tar.xz"
    echo -e "${BLUE}â€¢${NC} Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†Ø²ÙŠÙ„..."
    wget "$KALI_URL" -O kali-rootfs.tar.xz || {
        echo -e "${RED}[Ø®Ø·Ø£]${NC} ÙØ´Ù„ Ø§Ù„ØªÙ†Ø²ÙŠÙ„!"
        exit 1
    }

    # ÙÙƒ Ø§Ù„Ø¶ØºØ·
    echo -e "${BLUE}â€¢${NC} ÙÙƒ Ø§Ù„Ø¶ØºØ·..."
    mkdir -p kali-fs
    tar -xJf kali-rootfs.tar.xz -C kali-fs --exclude='dev/*' || {
        echo -e "${RED}[Ø®Ø·Ø£]${NC} ÙØ´Ù„ ÙÙƒ Ø§Ù„Ø¶ØºØ·!"
        exit 1
    }

    touch .kali-installed
}

post_installation() {
    echo -e "${YELLOW}[ØªÙ‡ÙŠØ¦Ø©]${NC} Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©..."
    
    proot --link2symlink -0 -r kali-fs -b /dev -b /proc -b /sys /usr/bin/env -i \
        HOME=/root \
        PATH=/usr/local/sbin:/usr/local/bin:/bin:/usr/bin:/sbin:/usr/sbin \
        TERM=xterm \
        /bin/bash -c "
        apt update -y
        apt full-upgrade -y
        apt install -y kali-tools-top10 nmap metasploit-framework
        echo 'alias ll=\"ls -alh\"' >> ~/.bashrc
        echo 'export HISTSIZE=10000' >> ~/.bashrc
    " || {
        echo -e "${RED}[Ø®Ø·Ø£]${NC} ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©!"
        exit 1
    }
}

gui_installation() {
    read -p "Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ© (XFCE4)ØŸ [y/N] " choice
    if [[ "$choice" =~ [Yy] ]]; then
        echo -e "${YELLOW}[GUI]${NC} ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©..."
        
        proot --link2symlink -0 -r kali-fs -b /dev -b /proc -b /sys /usr/bin/env -i \
            HOME=/root \
            PATH=/usr/local/sbin:/usr/local/bin:/bin:/usr/bin:/sbin:/usr/sbin \
            TERM=xterm \
            /bin/bash -c "
            apt install -y kali-desktop-xfce xfce4-terminal x11-apps
            apt clean
        " || {
            echo -e "${RED}[Ø®Ø·Ø£]${NC} ÙØ´Ù„ ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©!"
            exit 1
        }
    fi
}

create_launcher() {
    echo -e "${YELLOW}[ØªØ´ØºÙŠÙ„]${NC} Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØµØ§Ø±..."
    
    cat <<'EOF' > start-kali
#!/bin/bash

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù†
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Ø£ÙˆØ§Ù…Ø± PROOT Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
PROOT_CMD="proot \
--link2symlink \
--rootfs=\"\$PWD/kali-fs\" \
-b /dev \
-b /proc \
-b /sys \
-b /storage \
/usr/bin/env -i \
HOME=/root \
PATH=/usr/local/sbin:/usr/local/bin:/bin:/usr/bin:/sbin:/usr/sbin \
TERM=xterm \
/bin/bash --login"

# Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¶Ø¹
clear
echo -e "${YELLOW}Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„:${NC}"
echo "1) ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (CLI)"
echo "2) Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ© (XFCE)"
echo -n "Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± [1/2]: "
read mode

case $mode in
    2)
        if ! pgrep -x "termux-x11" >/dev/null; then
            echo -e "${RED}â–¶ ÙŠÙ„Ø²Ù… ØªØ«Ø¨ÙŠØª Termux-X11 Ø£ÙˆÙ„Ø§Ù‹!${NC}"
            exit 1
        fi
        eval "$PROOT_CMD -w /root -b /tmp:/tmp -- /usr/bin/startxfce4"
        ;;
    *)
        eval "$PROOT_CMD"
        ;;
esac
EOF

    chmod +x start-kali
}

# ------ Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ------
set -e
trap 'echo -e "${RED}[Ø®Ø·Ø£]${NC} ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù!"; exit 1' SIGINT

clear
echo -e "${GREEN}ğŸ›¡ï¸  Ø¨Ø¯Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¢Ù…Ù† Ù„ÙƒØ§Ù„ÙŠ Ù„ÙŠÙ†ÙƒØ³ ğŸ›¡ï¸${NC}"

clean_previous_attempts
check_dependencies
install_kali
post_installation
gui_installation
create_launcher

echo -e "\n${GREEN}âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ù†Ø¬Ø§Ø­!${NC}"
echo -e "${YELLOW}Ù„Ù„ØªØ´ØºÙŠÙ„:${NC}"
echo -e "  ${BLUE}./start-kali${NC}    - ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙˆØ§Ù…Ø±"
echo -e "  ${BLUE}./start-kali 2${NC}  - Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ©"
echo -e "\n${YELLOW}Ù…Ù„Ø§Ø­Ø¸Ø©:${NC} Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© ÙÙŠ: ${LOG_FILE}"

exit 0
